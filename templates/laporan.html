<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Laporan Absensi Warga Binaan Sosial</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { 
            background-color: #f9fafb; 
            padding: 30px; 
            font-family: 'Segoe UI', sans-serif; 
        }
        h1, h2 { 
            text-align: center; 
            color: #222; 
        }
        h1 { 
            font-weight: 800; 
            font-size: 22px; 
            margin-bottom: 0; 
            white-space: nowrap;       /* ‚¨ÖÔ∏è Supaya teks tidak turun ke bawah */
            overflow: hidden;          /* Hindari overflow saat cetak */
            text-overflow: ellipsis;   /* Aman kalau halaman kecil */
            letter-spacing: 0.5px;     /* Spasi sedikit biar rapi */
        }
        h2 { 
            font-weight: 700; 
            font-size: 20px; 
            margin-top: 5px; 
            margin-bottom: 30px; 
        }
        table { margin-top: 20px; width: 100%; }
        th, td { 
            vertical-align: middle !important; 
            text-align: center; 
        }

        #footer-tanggal { 
            text-align: right; 
            margin-top: 40px;
            font-size: 15px;
            display: none;
        }

        #ttd-section { 
            margin-top: 20px; 
            text-align: center; 
            display: none; 
            justify-content: space-around; 
        }

        #ttd-section div { width: 40%; }
        #ttd-section p { margin-bottom: 60px; }

        .header-line {
            border-top: 3px solid #000;
            border-bottom: 1px solid #000;
            margin: 10px 0 25px 0;
        }

        @media print {
            .no-print { display: none !important; }
            body { padding: 0; }
            #footer-tanggal, #ttd-section { page-break-inside: avoid; }
            h1 {
                font-size: 20px;          /* Sedikit kecil agar muat di cetak */
                letter-spacing: 0.3px;
                white-space: nowrap;      /* Tetap dalam satu baris */
            }
        }
    </style>
</head>
<body>
<div class="container bg-white p-4 rounded shadow">

    <!-- HEADER LEMBAGA -->
    <div class="text-center mb-3">
        <h1>PANTI SOSIAL BINA REMAJA TARUNA JAYA 2</h1>
        <div class="header-line"></div>
        <h2>Laporan Absensi Warga Binaan Sosial</h2>
    </div>

    <!-- Filter tanggal -->
    <div class="row mb-3 no-print">
        <div class="col-md-3">
            <label for="tglMulai" class="form-label">Tanggal:</label>
            <input type="date" id="tglMulai" class="form-control">
        </div>
        <div class="col-md-6 d-flex align-items-end">
            <button id="tampilkanBtn" class="btn btn-primary me-2">Tampilkan</button>
            <button id="cetakBtn" class="btn btn-success">Cetak</button>
        </div>
    </div>

    <!-- Tabel laporan -->
    <table class="table table-bordered table-striped" id="laporanTable">
        <thead class="table-dark text-center">
            <tr>
                <th>Tanggal</th>
                <th>Waktu</th>
                <th>Nama WBS</th>
                <th>Kegiatan</th>
            </tr>
        </thead>
        <tbody>
            <tr><td colspan="4" class="text-center text-muted">Memuat data...</td></tr>
        </tbody>
    </table>

    <!-- Bagian tanda tangan dan tanggal -->
    <div id="footer-tanggal">
        <p id="lokasiTanggal"></p>
    </div>

    <div id="ttd-section">
        <div>
            <p><strong>Pejabat Pelaksana Teknis Kegiatan</strong></p>
            <p id="pptkNama">................................</p>
        </div>
        <div>
            <p><strong>Narasumber</strong></p>
            <p id="narasumberNama">................................</p>
        </div>
    </div>
</div>

<script>
// üîπ Format tanggal ke dd-mm-yyyy
function formatTanggal(tgl) {
    if (!tgl) return '-';
    const [y, m, d] = tgl.split('-');
    return `${d}-${m}-${y}`;
}

// üîπ Format tanggal Indonesia (contoh: Tangerang Selatan, 25 Oktober 2025)
function formatTanggalIndonesia(date) {
    const bulan = [
        "Januari", "Februari", "Maret", "April", "Mei", "Juni",
        "Juli", "Agustus", "September", "Oktober", "November", "Desember"
    ];
    const tgl = date.getDate();
    const bln = bulan[date.getMonth()];
    const thn = date.getFullYear();
    return `Tangerang Selatan, ${tgl} ${bln} ${thn}`;
}

// üîπ Load data laporan
function loadLaporan() {
    const tglMulai = document.getElementById("tglMulai").value;
    let url = "/api/laporan";
    if (tglMulai) url += `?tgl_mulai=${tglMulai}`;

    fetch(url)
        .then(res => res.json())
        .then(data => {
            const tbody = document.querySelector("#laporanTable tbody");
            tbody.innerHTML = "";

            if (data.status === "success" && data.data.length > 0) {
                let pptk = "";
                let narasumber = "";

                data.data.forEach(item => {
                    const row = `
                        <tr>
                            <td>${formatTanggal(item.tanggal)}</td>
                            <td>${item.waktu_absensi}</td>
                            <td>${item.nama_wbs || '-'}</td>
                            <td>${item.nama_kegiatan || '-'}</td>
                        </tr>
                    `;
                    tbody.insertAdjacentHTML("beforeend", row);

                    if (item.narasumber && item.narasumber.includes("PPTK")) {
                        const parts = item.narasumber.split("|");
                        pptk = parts[0]?.replace("PPTK:", "").trim();
                        narasumber = parts[1]?.replace("Narasumber:", "").trim();
                    }
                });

                document.getElementById("ttd-section").style.display = "flex";
                document.getElementById("footer-tanggal").style.display = "block";
                document.getElementById("pptkNama").innerText = pptk || "................................";
                document.getElementById("narasumberNama").innerText = narasumber || "................................";

                const today = new Date();
                document.getElementById("lokasiTanggal").innerText = formatTanggalIndonesia(today);
            } else {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">Tidak ada data absensi pada tanggal ini.</td></tr>`;
                document.getElementById("ttd-section").style.display = "none";
                document.getElementById("footer-tanggal").style.display = "none";
            }
        })
        .catch(err => {
            console.error(err);
            Swal.fire("Error", "Gagal memuat data laporan", "error");
        });
}

// üîπ Event tombol
document.getElementById("tampilkanBtn").addEventListener("click", loadLaporan);
document.getElementById("cetakBtn").addEventListener("click", () => window.print());
window.onload = loadLaporan;
</script>
</body>
</html>
